{% extends "base.html" %}

{% block title %}Kampanie - AI Rekruter{% endblock %}

{% block head %}
{{ super() }}
<script defer>
    // Przeniesienie funkcji do globalnego zakresu
    window.confirmDelete = function(campaignId) {
        if (confirm('Czy na pewno chcesz usunąć tę kampanię?')) {
            fetch(`/campaigns/${campaignId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
            }).then(async response => {
                if (response.ok) {
                    const data = await response.json();
                    console.log('Success:', data);
                    window.location.href = "{{ url_for('campaign.list') }}";
                } else {
                    const error = await response.json();
                    console.error('Error:', error);
                    alert('Wystąpił błąd podczas usuwania kampanii: ' + error.error);
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('Wystąpił błąd podczas usuwania kampanii');
            });
        }
    }

    // Przeniesienie obsługi kopiowania linku
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.copy-link').forEach(button => {
            button.addEventListener('click', function() {
                navigator.clipboard.writeText(this.dataset.link);
                this.textContent = 'Skopiowano!';
                setTimeout(() => {
                    this.textContent = 'Kopiuj link';
                }, 2000);
            });
        });

        // New form validation for both add and edit forms
        ['addCampaignForm', 'editCampaignForm'].forEach(formId => {
            const form = document.getElementById(formId);
            if (form) {
                form.addEventListener('submit', function(e) {
                    const minSalary = parseInt(this.querySelector('[name="salary_range_min"]').value);
                    const maxSalary = parseInt(this.querySelector('[name="salary_range_max"]').value);
                    
                    if (minSalary && maxSalary && minSalary > maxSalary) {
                        e.preventDefault();
                        alert('Dolna granica wynagrodzenia nie może być wyższa niż górna granica.');
                    }
                });
            }
        });

        // Single counter for both add and edit
        let testCounter = 0;

        // Add test button for add campaign
        document.getElementById('addTestBtn')?.addEventListener('click', function() {
            const testHtml = createTestHtml(null, testCounter);
            document.getElementById('testsContainer').insertAdjacentHTML('beforeend', testHtml);
            testCounter++;
        });

        // Add test button for edit campaign
        document.getElementById('editAddTestBtn')?.addEventListener('click', function() {
            const testHtml = createTestHtml(null, testCounter);
            document.getElementById('editTestsContainer').insertAdjacentHTML('beforeend', testHtml);
            testCounter++;
        });

        // Handle test removal for both add and edit
        ['testsContainer', 'editTestsContainer'].forEach(containerId => {
            document.getElementById(containerId)?.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-test')) {
                    if (confirm('Czy na pewno chcesz usunąć ten test?')) {
                        const testCard = e.target.closest('.test-card');
                        testCard.remove();
                        
                        // Update test numbering
                        this.querySelectorAll('.test-card').forEach((card, index) => {
                            card.querySelector('.card-header h5').textContent = `Test ${index + 1}`;
                        });
                    }
                }
            });
        });

        // Handle form submission for both add and edit
        ['addCampaignForm', 'editCampaignForm'].forEach(formId => {
            document.getElementById(formId)?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                // Get all test cards
                const testCards = this.querySelectorAll('.test-card');
                console.log(`Found ${testCards.length} tests in ${formId}`);
                
                // Add test data to formData
                testCards.forEach((card, index) => {
                    const testData = {
                        id: card.dataset.testId, // Will be undefined for new tests
                        test_type: card.querySelector('[name^="tests"][name$="[test_type]"]').value,
                        stage: card.querySelector('[name^="tests"][name$="[stage]"]').value,
                        weight: card.querySelector('[name^="tests"][name$="[weight]"]').value,
                        description: card.querySelector('[name^="tests"][name$="[description]"]').value,
                        passing_threshold: card.querySelector('[name^="tests"][name$="[passing_threshold]"]').value,
                        time_limit_minutes: card.querySelector('[name^="tests"][name$="[time_limit_minutes]"]').value
                    };
                    console.log(`Test data for ${formId}:`, testData);
                    formData.append('tests', JSON.stringify(testData));
                });
                
                // Submit the form
                fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(html => {
                    window.location.href = "{{ url_for('campaign.list') }}";
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Wystąpił błąd podczas zapisywania kampanii');
                });
            });
        });

        // Edit campaign modal population
        window.editCampaign = function(campaignId) {
            testCounter = 0; // Reset counter when opening edit modal
            
            fetch(`/campaigns/${campaignId}/data`)
                .then(response => response.ok ? response.json() : Promise.reject('Network response was not ok'))
                .then(campaign => {
                    if (!campaign) throw new Error('No campaign data received');

                    const form = document.getElementById('editCampaignForm');
                    form.action = `/campaigns/${campaignId}/edit`;
                    
                    // Update campaign fields
                    Object.entries({
                        'edit_code': campaign.code,
                        'edit_title': campaign.title,
                        'edit_workplace_location': campaign.workplace_location,
                        'edit_contract_type': campaign.contract_type,
                        'edit_employment_type': campaign.employment_type,
                        'edit_work_start_date': campaign.work_start_date,
                        'edit_duties': campaign.duties,
                        'edit_requirements': campaign.requirements,
                        'edit_employer_offerings': campaign.employer_offerings,
                        'edit_job_description': campaign.job_description,
                        'edit_salary_range_min': campaign.salary_range_min,
                        'edit_salary_range_max': campaign.salary_range_max
                    }).forEach(([id, value]) => {
                        const element = form.querySelector(`#${id}`);
                        if (element) element.value = value || '';
                    });
                    
                    form.querySelector('#edit_is_active').checked = campaign.is_active || false;
                    
                    // Clear and populate tests
                    const testsContainer = document.getElementById('editTestsContainer');
                    testsContainer.innerHTML = '';
                    
                    if (campaign.tests?.length > 0) {
                        campaign.tests.forEach(test => {
                            testsContainer.insertAdjacentHTML('beforeend', createTestHtml(test, testCounter));
                            testCounter++;
                        });
                    }
                    
                    new bootstrap.Modal(document.getElementById('editCampaignModal')).show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Wystąpił błąd podczas pobierania danych kampanii: ' + error);
                });
        };
    });

    // Function to create test HTML for edit modal
    function createTestHtml(testData = null, counter) {
        console.log('Creating test HTML with data:', testData);  // Debug log
        const test = testData || {};
        return `
            <div class="card mb-3 test-card" data-test-id="${test.id || ''}" data-counter="${counter}">
                <div class="card-header">
                    <h5>Test ${counter + 1}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Typ testu*</label>
                            <select class="form-select" name="tests[${counter}][test_type]" required>
                                <option value="SURVEY" ${test.test_type === 'SURVEY' ? 'selected' : ''}>Ankieta</option>
                                <option value="EQ" ${test.test_type === 'EQ' ? 'selected' : ''}>Test EQ</option>
                                <option value="IQ" ${test.test_type === 'IQ' ? 'selected' : ''}>Test IQ</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Etap*</label>
                            <select class="form-select" name="tests[${counter}][stage]" required>
                                <option value="PO1" ${test.stage === 'PO1' ? 'selected' : ''}>PO1</option>
                                <option value="PO2" ${test.stage === 'PO2' ? 'selected' : ''}>PO2</option>
                                <option value="PO3" ${test.stage === 'PO3' ? 'selected' : ''}>PO3</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Waga testu*</label>
                            <input type="number" class="form-control" name="tests[${counter}][weight]" 
                                   value="${test.weight !== undefined ? test.weight : ''}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Opis testu</label>
                            <textarea class="form-control" name="tests[${counter}][description]" rows="2">${test.description || ''}</textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Próg zaliczenia*</label>
                            <input type="number" class="form-control" name="tests[${counter}][passing_threshold]" 
                                   value="${test.passing_threshold !== undefined ? test.passing_threshold : '0'}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Limit czasu (minuty)</label>
                            <input type="number" class="form-control" name="tests[${counter}][time_limit_minutes]" 
                                   value="${test.time_limit_minutes !== undefined ? test.time_limit_minutes : '0'}">
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger remove-test">Usuń test</button>
                </div>
            </div>
        `;
    }
</script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Kampanie rekrutacyjne</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCampaignModal">
        Dodaj kampanię
    </button>
</div>

<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Kod kampanii</th>
                <th>Tytuł</th>
                <th>Lokalizacja</th>
                <th>Data utworzenia</th>
                <th>Status</th>
                <th>Link</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
            {% for campaign in campaigns %}
            <tr>
                <td>{{ campaign.code }}</td>
                <td>{{ campaign.title }}</td>
                <td>{{ campaign.workplace_location }}</td>
                <td>{{ campaign.created_at|datetime }}</td>
                <td>
                    <span class="badge {% if campaign.is_active %}bg-success{% else %}bg-danger{% endif %}">
                        {{ 'Aktywna' if campaign.is_active else 'Nieaktywna' }}
                    </span>
                </td>
                <td>
                    {% if campaign.universal_access_token %}
                        <button class="btn btn-sm btn-secondary copy-link" 
                                data-link="{{ request.host_url }}test/{{ campaign.universal_access_token }}">
                            Kopiuj link
                        </button>
                    {% else %}
                        <form method="POST" action="{{ url_for('campaign.generate_link', id=campaign.id) }}" 
                              class="d-inline">
                            <button type="submit" class="btn btn-sm btn-primary">Generuj link</button>
                        </form>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-warning" 
                                onclick="editCampaign('{{ campaign.id }}')">Edytuj</button>
                        <button type="button" class="btn btn-sm btn-danger" 
                                onclick="confirmDelete('{{ campaign.id }}')">Usuń</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add Campaign Modal -->
<div class="modal fade" id="addCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dodaj nową kampanię</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCampaignForm" method="POST" action="{{ url_for('campaign.add') }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="code" class="form-label">Kod kampanii*</label>
                            <input type="text" class="form-control" id="code" name="code" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="title" class="form-label">Tytuł kampanii*</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="workplace_location" class="form-label">Miejsce pracy*</label>
                            <input type="text" class="form-control" id="workplace_location" name="workplace_location" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="contract_type" class="form-label">Rodzaj umowy*</label>
                            <select class="form-select" id="contract_type" name="contract_type" required>
                                <option value="umowa o pracę">Umowa o pracę</option>
                                <option value="B2B">B2B</option>
                                <option value="umowa zlecenie">Umowa zlecenie</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="employment_type" class="form-label">Rodzaj etatu*</label>
                            <select class="form-select" id="employment_type" name="employment_type" required>
                                <option value="pełny etat">Pełny etat</option>
                                <option value="część etatu">Część etatu</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="work_start_date" class="form-label">Data rozpoczęcia pracy*</label>
                        <input type="date" class="form-control" id="work_start_date" name="work_start_date" required>
                    </div>

                    <div class="mb-3">
                        <label for="duties" class="form-label">Opis obowiązków*</label>
                        <textarea class="form-control" id="duties" name="duties" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="requirements" class="form-label">Wymagania*</label>
                        <textarea class="form-control" id="requirements" name="requirements" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="employer_offerings" class="form-label">Co oferuje pracodawca*</label>
                        <textarea class="form-control" id="employer_offerings" name="employer_offerings" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="job_description" class="form-label">Opis czego potrzebujemy*</label>
                        <textarea class="form-control" id="job_description" name="job_description" rows="3" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="salary_range_min" class="form-label">Dolna granica wynagrodzenia (PLN)</label>
                            <input type="number" class="form-control" id="salary_range_min" name="salary_range_min">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="salary_range_max" class="form-label">Górna granica wynagrodzenia (PLN)</label>
                            <input type="number" class="form-control" id="salary_range_max" name="salary_range_max">
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="addTestBtn">Dodaj test</button>
                    </div>

                    <div id="testsContainer"></div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">Zapisz kampanię</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Campaign Modal -->
<div class="modal fade" id="editCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edytuj kampanię</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCampaignForm" method="POST">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_code" class="form-label">Kod kampanii*</label>
                            <input type="text" class="form-control" id="edit_code" name="code" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_title" class="form-label">Tytuł kampanii*</label>
                            <input type="text" class="form-control" id="edit_title" name="title" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="edit_workplace_location" class="form-label">Miejsce pracy*</label>
                            <input type="text" class="form-control" id="edit_workplace_location" name="workplace_location" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="edit_contract_type" class="form-label">Rodzaj umowy*</label>
                            <select class="form-select" id="edit_contract_type" name="contract_type" required>
                                <option value="umowa o pracę">Umowa o pracę</option>
                                <option value="B2B">B2B</option>
                                <option value="umowa zlecenie">Umowa zlecenie</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="edit_employment_type" class="form-label">Rodzaj etatu*</label>
                            <select class="form-select" id="edit_employment_type" name="employment_type" required>
                                <option value="pełny etat">Pełny etat</option>
                                <option value="część etatu">Część etatu</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_work_start_date" class="form-label">Data rozpoczęcia pracy*</label>
                        <input type="date" class="form-control" id="edit_work_start_date" name="work_start_date" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit_duties" class="form-label">Opis obowiązków*</label>
                        <textarea class="form-control" id="edit_duties" name="duties" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="edit_requirements" class="form-label">Wymagania*</label>
                        <textarea class="form-control" id="edit_requirements" name="requirements" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="edit_employer_offerings" class="form-label">Co oferuje pracodawca*</label>
                        <textarea class="form-control" id="edit_employer_offerings" name="employer_offerings" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="edit_job_description" class="form-label">Opis czego potrzebujemy*</label>
                        <textarea class="form-control" id="edit_job_description" name="job_description" rows="3" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_salary_range_min" class="form-label">Dolna granica wynagrodzenia (PLN)</label>
                            <input type="number" class="form-control" id="edit_salary_range_min" name="salary_range_min">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_salary_range_max" class="form-label">Górna granica wynagrodzenia (PLN)</label>
                            <input type="number" class="form-control" id="edit_salary_range_max" name="salary_range_max">
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="edit_is_active" name="is_active">
                        <label class="form-check-label" for="edit_is_active">Kampania aktywna</label>
                    </div>

                    <div class="mb-3">
                        <h4>Testy</h4>
                        <button type="button" class="btn btn-secondary" id="editAddTestBtn">Dodaj test</button>
                    </div>

                    <div id="editTestsContainer">
                        <!-- Tests will be populated here -->
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}