{% extends "admin_navigation.html" %}

{% block title %}Kampanie - AI Rekruter{% endblock %}

{% block content %}
{% if error_message %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        showToast('{{ error_message }}', 'error');
    });
</script>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Kampanie rekrutacyjne</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCampaignModal">
        Dodaj kampanię
    </button>
</div>

<div class="table-wrapper">
    <div class="table-scroll">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Kod kampanii</th>
                    <th>Tytuł</th>
                    <th>Lokalizacja</th>
                    <th>Status</th>
                    <th>Link</th>
                    <th>Data utworzenia</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for campaign in campaigns %}
                <tr data-campaign-id="{{ campaign.id }}" ondblclick="editCampaign('{{ campaign.id }}')" style="cursor: pointer;">
                    <td>{{ campaign.code }}</td>
                    <td>{{ campaign.title }}</td>
                    <td>{{ campaign.workplace_location }}</td>
                    <td>
                        <span class="badge {% if campaign.is_active %}bg-success{% else %}bg-danger{% endif %}">
                            {{ 'Aktywna' if campaign.is_active else 'Nieaktywna' }}
                        </span>
                    </td>
                    <td>
                        {% if campaign.universal_access_token %}
                            <button class="btn btn-sm btn-secondary copy-link" 
                                    data-link="{{ request.host_url }}test/{{ campaign.universal_access_token }}">
                                Kopiuj link
                            </button>
                        {% else %}
                            <button type="button" class="btn btn-sm btn-primary generate-link-list" 
                                    data-campaign-id="{{ campaign.id }}" 
                                    data-campaign-code="{{ campaign.code }}">
                                Generuj link
                            </button>
                        {% endif %}
                    </td>
                    <td>{{ campaign.created_at|datetime }}</td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-warning" 
                                    onclick="editCampaign('{{ campaign.id }}')">Edytuj</button>
                            <button type="button" class="btn btn-sm btn-info" 
                                    onclick="cloneCampaign('{{ campaign.id }}')">Duplikuj</button>
                            <button type="button" class="btn btn-sm btn-danger" 
                                    onclick="confirmDelete('{{ campaign.id }}')">Usuń</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Campaign Modal -->
<div class="modal fade" id="addCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dodaj nową kampanię</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCampaignForm" method="POST" action="{{ url_for('campaign.add') }}">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input type="checkbox" class="form-check-input" name="is_active" checked>
                                <label class="form-check-label">Kampania aktywna</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Kod kampanii*</label>
                            <input type="text" class="form-control" name="code" required>
                            <div class="invalid-feedback" style="display: none;">
                                Kampania o takim kodzie już istnieje
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tytuł*</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Lokalizacja*</label>
                            <input type="text" class="form-control" name="workplace_location" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data rozpoczęcia pracy*</label>
                            <input type="date" class="form-control" name="work_start_date" required 
                                   onclick="this.showPicker()">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Typ umowy*</label>
                            <input type="text" class="form-control" name="contract_type" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Wymiar pracy*</label>
                            <input type="text" class="form-control" name="employment_type" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Wynagrodzenie od</label>
                            <input type="number" class="form-control" name="salary_range_min">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Wynagrodzenie do</label>
                            <input type="number" class="form-control" name="salary_range_max">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Obowiązki*</label>
                            <textarea class="form-control" name="duties" rows="3" required></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Wymagania*</label>
                            <textarea class="form-control" name="requirements" rows="3" required></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Oferujemy*</label>
                            <textarea class="form-control" name="employer_offerings" rows="3" required></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Opis stanowiska*</label>
                            <textarea class="form-control" name="job_description" rows="3" required></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12 mb-3">
                            <label class="form-label">Grupa*</label>
                            <select class="form-select" name="group_id" required onchange="updateTestOptions(this)">
                                <option value="">Wybierz grupę</option>
                                {% for group in groups %}
                                    <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                Należy wybrać grupę
                            </div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <div class="flex-grow-1">
                                    <label class="form-label">Test PO1</label>
                                    <select class="form-select" name="po1_test_id" onchange="updateWeightValidation()">
                                        <option value="">Brak</option>
                                        {% for test in tests %}
                                            <option value="{{ test.id }}">
                                                {{ test.title }} - {{ test.test_type }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div style="width: 120px;">
                                    <label class="form-label">Waga (%)</label>
                                    <input type="number" class="form-control" name="po1_test_weight" min="0" max="100" value="100">
                                    <div class="invalid-feedback">
                                        Nieprawidłowa waga
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <div class="flex-grow-1">
                                    <label class="form-label">Test PO2</label>
                                    <select class="form-select" name="po2_test_id" onchange="updateWeightValidation()">
                                        <option value="">Brak</option>
                                        {% for test in tests %}
                                            <option value="{{ test.id }}">
                                                {{ test.title }} - {{ test.test_type }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div style="width: 120px;">
                                    <label class="form-label">Waga (%)</label>
                                    <input type="number" class="form-control" name="po2_test_weight" min="0" max="100" value="0">
                                    <div class="invalid-feedback">
                                        Nieprawidłowa waga
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex align-items-center gap-2">
                                <div class="flex-grow-1">
                                    <label class="form-label">Test PO3</label>
                                    <select class="form-select" name="po3_test_id" onchange="updateWeightValidation()">
                                        <option value="">Brak</option>
                                        {% for test in tests %}
                                            <option value="{{ test.id }}">
                                                {{ test.title }} - {{ test.test_type }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div style="width: 120px;">
                                    <label class="form-label">Waga (%)</label>
                                    <input type="number" class="form-control" name="po3_test_weight" min="0" max="100" value="0">
                                    <div class="invalid-feedback">
                                        Nieprawidłowa waga
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mt-2">
                            <div class="alert alert-danger d-none" id="weightValidationAlert">
                                Suma wag dla wybranych testów musi wynosić 100%
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn btn-primary ms-2" id="addCampaignSubmit">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <span class="button-text">Zapisz kampanię</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Campaign Modal -->
<div class="modal fade" id="editCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edytuj kampanię</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCampaignForm" method="POST">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input type="checkbox" class="form-check-input" name="is_active">
                                <label class="form-check-label">Kampania aktywna</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Kod kampanii*</label>
                            <input type="text" class="form-control" name="code" required>
                            <div class="invalid-feedback" style="display: none;">
                                Kampania o takim kodzie już istnieje
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tytuł*</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Lokalizacja*</label>
                            <input type="text" class="form-control" name="workplace_location" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data rozpoczęcia pracy*</label>
                            <input type="date" class="form-control" name="work_start_date" required 
                                   onclick="this.showPicker()">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Typ umowy*</label>
                            <input type="text" class="form-control" name="contract_type" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Wymiar pracy*</label>
                            <input type="text" class="form-control" name="employment_type" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Wynagrodzenie od</label>
                            <input type="number" class="form-control" name="salary_range_min">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Wynagrodzenie do</label>
                            <input type="number" class="form-control" name="salary_range_max">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Obowiązki*</label>
                            <textarea class="form-control" name="duties" rows="3" required></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Wymagania*</label>
                            <textarea class="form-control" name="requirements" rows="3" required></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Oferujemy*</label>
                            <textarea class="form-control" name="employer_offerings" rows="3" required></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Opis stanowiska*</label>
                            <textarea class="form-control" name="job_description" rows="3" required></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12 mb-3">
                            <label class="form-label">Grupa*</label>
                            <select class="form-select" name="group_id" required onchange="updateTestOptions(this)">
                                <option value="">Wybierz grupę</option>
                                {% for group in groups %}
                                    <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                Należy wybrać grupę
                            </div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <div class="flex-grow-1">
                                    <label class="form-label">Test PO1</label>
                                    <select class="form-select" name="po1_test_id" onchange="updateWeightValidation()">
                                        <option value="">Brak</option>
                                        {% for test in tests %}
                                            <option value="{{ test.id }}">
                                                {{ test.title }} - {{ test.test_type }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div style="width: 120px;">
                                    <label class="form-label">Waga (%)</label>
                                    <input type="number" class="form-control" name="po1_test_weight" min="0" max="100" value="100">
                                    <div class="invalid-feedback">
                                        Nieprawidłowa waga
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <div class="flex-grow-1">
                                    <label class="form-label">Test PO2</label>
                                    <select class="form-select" name="po2_test_id" onchange="updateWeightValidation()">
                                        <option value="">Brak</option>
                                        {% for test in tests %}
                                            <option value="{{ test.id }}">
                                                {{ test.title }} - {{ test.test_type }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div style="width: 120px;">
                                    <label class="form-label">Waga (%)</label>
                                    <input type="number" class="form-control" name="po2_test_weight" min="0" max="100" value="0">
                                    <div class="invalid-feedback">
                                        Nieprawidłowa waga
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex align-items-center gap-2">
                                <div class="flex-grow-1">
                                    <label class="form-label">Test PO3</label>
                                    <select class="form-select" name="po3_test_id" onchange="updateWeightValidation()">
                                        <option value="">Brak</option>
                                        {% for test in tests %}
                                            <option value="{{ test.id }}">
                                                {{ test.title }} - {{ test.test_type }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div style="width: 120px;">
                                    <label class="form-label">Waga (%)</label>
                                    <input type="number" class="form-control" name="po3_test_weight" min="0" max="100" value="0">
                                    <div class="invalid-feedback">
                                        Nieprawidłowa waga
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mt-2">
                            <div class="alert alert-danger d-none" id="weightValidationAlert">
                                Suma wag dla wybranych testów musi wynosić 100%
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn btn-primary ms-2" id="editCampaignSubmit">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <span class="button-text">Zapisz zmiany</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block head %}
{{ super() }}
<style>
    .table tbody tr:hover {
        background-color: rgba(0,0,0,.075);
    }
    
    .table-wrapper {
        height: calc(100vh - 250px);
    }
    
    .table-scroll {
        overflow-x: auto;
        overflow-y: auto;
        height: 100%;
    }
    
    /* Upewnij się, że dropdown jest zawsze na wierzchu */
    .dropdown-menu {
        z-index: 1021 !important;
    }
    
    /* Zapewnij, że dropdown nie jest obcięty */
    .table-scroll {
        overflow: visible !important;
        overflow-x: auto !important;
    }
    
    /* Popraw pozycjonowanie dropdown */
    .dropdown {
        position: relative !important;
    }
    
    /* Upewnij się, że komórka tabeli ma odpowiedni overflow */
    td {
        overflow: visible !important;
    }

    /* Ustaw sticky header */
    .table thead th {
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }

    /* Dodaj cień pod headerem tabeli */
    .table thead th {
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }

    /* Szerokości kolumn */
    .table th:nth-child(1),
    .table td:nth-child(1) { width: 12%; } /* Kod kampanii */
    
    .table th:nth-child(2),
    .table td:nth-child(2) { width: 20%; } /* Tytuł */
    
    .table th:nth-child(3),
    .table td:nth-child(3) { width: 15%; } /* Lokalizacja */
    
    .table th:nth-child(4),
    .table td:nth-child(4) { width: 8%; } /* Status */
    
    .table th:nth-child(5),
    .table td:nth-child(5) { width: 15%; } /* Link */
    
    .table th:nth-child(6),
    .table td:nth-child(6) { width: 15%; } /* Data utworzenia */
    
    .table th:nth-child(7),
    .table td:nth-child(7) { width: 15%; } /* Akcje */

    /* Obsługa długich tekstów w komórkach */
    .table td {
        max-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
<script defer>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle form submissions
        ['addCampaignForm', 'editCampaignForm'].forEach(formId => {
            const form = document.getElementById(formId);
            if (form) {
                form.addEventListener('submit', handleCampaignFormSubmit);
            }
        });

        // Handle copy link buttons
        document.querySelectorAll('.copy-link').forEach(button => {
            button.addEventListener('click', function() {
                const link = this.dataset.link;
                navigator.clipboard.writeText(link).then(() => {
                    showToast('Link został skopiowany do schowka', 'success');
                });
            });
        });

        // Handle generate link buttons
        document.querySelectorAll('.generate-link-list').forEach(button => {
            button.addEventListener('click', function() {
                const campaignId = this.dataset.campaignId;
                generateLink(campaignId);
            });
        });

        // Reset modal title when opening normally
        document.querySelector('[data-bs-target="#addCampaignModal"]').addEventListener('click', function() {
            document.querySelector('#addCampaignModal .modal-title').textContent = 'Dodaj nową kampanię';
        });

        // Add this to prevent double click from triggering when clicking buttons
        document.querySelectorAll('.btn-group button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });

        document.querySelectorAll('.copy-link, .generate-link-list').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
    });

    function editCampaign(campaignId) {
        fetch(`/campaigns/${campaignId}/data`)
            .then(response => response.json())
            .then(campaign => {
                console.log('Campaign data received:', campaign); // Debug log
                const form = document.getElementById('editCampaignForm');
                form.action = `/campaigns/${campaignId}/edit`;
                
                // Populate form fields
                form.querySelector('[name="code"]').value = campaign.code || '';
                form.querySelector('[name="title"]').value = campaign.title || '';
                form.querySelector('[name="workplace_location"]').value = campaign.workplace_location || '';
                form.querySelector('[name="work_start_date"]').value = campaign.work_start_date || '';
                form.querySelector('[name="contract_type"]').value = campaign.contract_type || '';
                form.querySelector('[name="employment_type"]').value = campaign.employment_type || '';
                form.querySelector('[name="salary_range_min"]').value = campaign.salary_range_min || '';
                form.querySelector('[name="salary_range_max"]').value = campaign.salary_range_max || '';
                form.querySelector('[name="duties"]').value = campaign.duties || '';
                form.querySelector('[name="requirements"]').value = campaign.requirements || '';
                form.querySelector('[name="employer_offerings"]').value = campaign.employer_offerings || '';
                form.querySelector('[name="job_description"]').value = campaign.job_description || '';
                form.querySelector('[name="is_active"]').checked = campaign.is_active;
                
                // Set group and trigger test updates
                const groupSelect = form.querySelector('[name="group_id"]');
                if (campaign.groups && campaign.groups.length > 0) {
                    groupSelect.value = campaign.groups[0].id;
                    updateTestOptions(groupSelect);
                    
                    // Store weights to set after test updates
                    const weights = {
                        po1: campaign.po1_test_weight || 0,
                        po2: campaign.po2_test_weight || 0,
                        po3: campaign.po3_test_weight || 0
                    };
                    console.log('Weights to set:', weights); // Debug log
                    
                    // Wait for tests to load before setting test selections
                    setTimeout(() => {
                        const po1Select = form.querySelector('[name="po1_test_id"]');
                        const po2Select = form.querySelector('[name="po2_test_id"]');
                        const po3Select = form.querySelector('[name="po3_test_id"]');
                        
                        if (campaign.po1_test_id) {
                            po1Select.value = campaign.po1_test_id;
                            po2Select.disabled = false;
                        }
                        
                        if (campaign.po2_test_id) {
                            po2Select.value = campaign.po2_test_id;
                            po3Select.disabled = false;
                        }
                        
                        if (campaign.po3_test_id) {
                            po3Select.value = campaign.po3_test_id;
                        }
                        
                        // Update dependencies after setting values
                        updateTestDependencies(form);
                        
                        // Set weights after dependencies are updated
                        const po1Weight = form.querySelector('[name="po1_test_weight"]');
                        const po2Weight = form.querySelector('[name="po2_test_weight"]');
                        const po3Weight = form.querySelector('[name="po3_test_weight"]');
                        
                        po1Weight.value = weights.po1;
                        po2Weight.value = weights.po2;
                        po3Weight.value = weights.po3;
                        
                        console.log('Weights set:', {
                            po1: po1Weight.value,
                            po2: po2Weight.value,
                            po3: po3Weight.value
                        }); // Debug log
                        
                        // Update max weights after setting values
                        updateMaxWeights(form);
                    }, 500);
                }
                
                new bootstrap.Modal(document.getElementById('editCampaignModal')).show();
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Błąd podczas ładowania danych kampanii', 'error');
            });
    }

    function confirmDelete(campaignId) {
        if (confirm('Czy na pewno chcesz usunąć tę kampanię?')) {
            fetch(`/campaigns/${campaignId}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`tr[data-campaign-id="${campaignId}"]`).remove();
                    showToast('Kampania została usunięta', 'success');
                } else {
                    throw new Error(data.error || 'Wystąpił błąd podczas usuwania kampanii');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast(error.message, 'error');
            });
        }
    }

    function handleCampaignFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        
        // Reset validation state
        form.querySelectorAll('[name$="_test_weight"]').forEach(input => {
            input.classList.remove('is-invalid');
        });
        form.querySelector('#weightValidationAlert').classList.add('d-none');
        
        // Get test selects and weights
        const po1Select = form.querySelector('[name="po1_test_id"]');
        const po2Select = form.querySelector('[name="po2_test_id"]');
        const po3Select = form.querySelector('[name="po3_test_id"]');
        
        const po1Weight = form.querySelector('[name="po1_test_weight"]');
        const po2Weight = form.querySelector('[name="po2_test_weight"]');
        const po3Weight = form.querySelector('[name="po3_test_weight"]');
        
        // Calculate sum of weights for active tests
        let sum = 0;
        let activeTests = 0;
        
        if (po1Select.value) {
            sum += parseInt(po1Weight.value) || 0;
            activeTests++;
        }
        if (po2Select.value) {
            sum += parseInt(po2Weight.value) || 0;
            activeTests++;
        }
        if (po3Select.value) {
            sum += parseInt(po3Weight.value) || 0;
            activeTests++;
        }
        
        // Validate only if there are active tests
        if (activeTests > 0 && sum !== 100) {
            [po1Weight, po2Weight, po3Weight].forEach(input => {
                if (input.closest('.d-flex').querySelector('select').value) {
                    input.classList.add('is-invalid');
                }
            });
            form.querySelector('#weightValidationAlert').classList.remove('d-none');
            showToast('Suma wag dla wybranych testów musi wynosić 100%', 'error');
            return;
        }
        
        // Rest of your existing form submission code...
        const formData = new FormData(form);
        const code = formData.get('code');
        const campaignId = form.action.includes('/edit') ? form.action.split('/').slice(-2)[0] : null;
        const codeInput = form.querySelector('[name="code"]');
        const feedbackDiv = codeInput.nextElementSibling;
        
        // Get submit button and show loading state
        const submitButton = form.querySelector('button[type="submit"]');
        const spinner = submitButton.querySelector('.spinner-border');
        const buttonText = submitButton.querySelector('.button-text');
        
        // Show loading state
        submitButton.disabled = true;
        spinner.classList.remove('d-none');
        buttonText.textContent = 'Zapisywanie...';
        
        // First check if code exists
        fetch('/campaigns/check-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: code,
                campaign_id: campaignId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.valid) {
                codeInput.classList.add('is-invalid');
                feedbackDiv.style.display = 'block';
                feedbackDiv.textContent = data.error;
                
                submitButton.disabled = false;
                spinner.classList.add('d-none');
                buttonText.textContent = campaignId ? 'Zapisz zmiany' : 'Zapisz kampanię';
                
                throw new Error(data.error);
            }
            
            return fetch(form.action, {
                method: 'POST',
                body: formData
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sessionStorage.setItem('pendingToast', JSON.stringify({
                    message: campaignId ? 'Kampania została zaktualizowana' : 'Kampania została dodana',
                    type: 'success'
                }));
                window.location.reload();
            } else {
                throw new Error(data.error || 'Wystąpił błąd podczas zapisywania kampanii');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (!codeInput.classList.contains('is-invalid')) {
                showToast(error.message, 'error');
            }
            
            if (!codeInput.classList.contains('is-invalid')) {
                submitButton.disabled = false;
                spinner.classList.add('d-none');
                buttonText.textContent = campaignId ? 'Zapisz zmiany' : 'Zapisz kampanię';
            }
        });
    }

    function generateLink(campaignId) {
        fetch(`/campaigns/${campaignId}/generate-link`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                throw new Error(data.error || 'Wystąpił błąd podczas generowania linku');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast(error.message, 'error');
        });
    }

    function cloneCampaign(campaignId) {
        fetch(`/campaigns/${campaignId}/data`)
            .then(response => response.json())
            .then(campaign => {
                const form = document.getElementById('addCampaignForm');
                
                // Populate form fields except code
                form.querySelector('[name="code"]').value = ''; // Leave empty
                form.querySelector('[name="title"]').value = campaign.title || '';
                form.querySelector('[name="workplace_location"]').value = campaign.workplace_location || '';
                form.querySelector('[name="work_start_date"]').value = campaign.work_start_date || '';
                form.querySelector('[name="contract_type"]').value = campaign.contract_type || '';
                form.querySelector('[name="employment_type"]').value = campaign.employment_type || '';
                form.querySelector('[name="salary_range_min"]').value = campaign.salary_range_min || '';
                form.querySelector('[name="salary_range_max"]').value = campaign.salary_range_max || '';
                form.querySelector('[name="duties"]').value = campaign.duties || '';
                form.querySelector('[name="requirements"]').value = campaign.requirements || '';
                form.querySelector('[name="employer_offerings"]').value = campaign.employer_offerings || '';
                form.querySelector('[name="job_description"]').value = campaign.job_description || '';
                form.querySelector('[name="is_active"]').checked = campaign.is_active;
                
                // Set group and trigger test updates
                const groupSelect = form.querySelector('[name="group_id"]');
                if (campaign.groups && campaign.groups.length > 0) {
                    groupSelect.value = campaign.groups[0].id;
                    updateTestOptions(groupSelect);
                    
                    // Store weights to set after test updates
                    const weights = {
                        po1: campaign.po1_test_weight || 0,
                        po2: campaign.po2_test_weight || 0,
                        po3: campaign.po3_test_weight || 0
                    };
                    
                    // Wait for tests to load before setting test selections
                    setTimeout(() => {
                        const po1Select = form.querySelector('[name="po1_test_id"]');
                        const po2Select = form.querySelector('[name="po2_test_id"]');
                        const po3Select = form.querySelector('[name="po3_test_id"]');
                        
                        if (campaign.po1_test_id) {
                            po1Select.value = campaign.po1_test_id;
                            po2Select.disabled = false;
                        }
                        
                        if (campaign.po2_test_id) {
                            po2Select.value = campaign.po2_test_id;
                            po3Select.disabled = false;
                        }
                        
                        if (campaign.po3_test_id) {
                            po3Select.value = campaign.po3_test_id;
                        }
                        
                        // Update dependencies after setting values
                        updateTestDependencies(form);
                        
                        // Set weights after dependencies are updated
                        form.querySelector('[name="po1_test_weight"]').value = weights.po1;
                        form.querySelector('[name="po2_test_weight"]').value = weights.po2;
                        form.querySelector('[name="po3_test_weight"]').value = weights.po3;
                        
                        // Update max weights after setting values
                        updateMaxWeights(form);
                    }, 500);
                }
                
                // Update modal title to indicate duplication
                document.querySelector('#addCampaignModal .modal-title').textContent = 'Duplikuj kampanie';
                
                // Show the modal
                new bootstrap.Modal(document.getElementById('addCampaignModal')).show();
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Błąd podczas ładowania danych kampanii', 'error');
            });
    }

    function updateTestOptions(groupSelect) {
        const form = groupSelect.closest('form');
        const testSelects = form.querySelectorAll('[name$="_test_id"]');
        const weightInputs = form.querySelectorAll('[name$="_test_weight"]');
        const groupId = groupSelect.value;
        
        // Clear all test selections and disable both tests and weights
        testSelects.forEach((select, index) => {
            select.innerHTML = '<option value="">Brak</option>';
            select.disabled = !groupId;
            weightInputs[index].disabled = true; // Always disable weights initially
            weightInputs[index].value = index === 0 ? '100' : '0'; // Set PO1 to 100%, others to 0
        });
        
        if (groupId) {
            // Fetch tests for selected group
            fetch(`/campaigns/group/${groupId}/tests`)
                .then(response => response.json())
                .then(tests => {
                    // Update each test select with all available tests
                    testSelects.forEach(select => {
                        tests.forEach(test => {
                            const option = document.createElement('option');
                            option.value = test.id;
                            option.textContent = `${test.title} - ${test.test_type}`;
                            select.appendChild(option);
                        });
                    });
                    
                    // After populating tests, update dependencies
                    updateTestDependencies(form);
                })
                .catch(error => {
                    console.error('Error fetching tests:', error);
                    showToast('Błąd podczas pobierania testów', 'error');
                });
        }
    }

    function updateTestDependencies(form) {
        const po1Select = form.querySelector('[name="po1_test_id"]');
        const po2Select = form.querySelector('[name="po2_test_id"]');
        const po3Select = form.querySelector('[name="po3_test_id"]');
        
        const po1Weight = form.querySelector('[name="po1_test_weight"]');
        const po2Weight = form.querySelector('[name="po2_test_weight"]');
        const po3Weight = form.querySelector('[name="po3_test_weight"]');
        
        // Handle PO1 weight - enabled only when test select is enabled
        po1Weight.disabled = po1Select.disabled;
        
        // Handle PO2 dependency on PO1
        if (!po1Select.value) {
            po2Select.value = '';
            po2Select.disabled = true;
            po2Weight.value = '0';
            po2Weight.disabled = true;
        } else {
            po2Select.disabled = false;
            po2Weight.disabled = po2Select.disabled;
        }
        
        // Handle PO3 dependency on PO2
        if (!po2Select.value) {
            po3Select.value = '';
            po3Select.disabled = true;
            po3Weight.value = '0';
            po3Weight.disabled = true;
        } else {
            po3Select.disabled = false;
            po3Weight.disabled = po3Select.disabled;
        }
        
        // Update max weights after handling dependencies
        updateMaxWeights(form);
    }

    // Add new function to update max values
    function updateMaxWeights(form) {
        const po1Select = form.querySelector('[name="po1_test_id"]');
        const po2Select = form.querySelector('[name="po2_test_id"]');
        const po3Select = form.querySelector('[name="po3_test_id"]');
        
        const po1Weight = form.querySelector('[name="po1_test_weight"]');
        const po2Weight = form.querySelector('[name="po2_test_weight"]');
        const po3Weight = form.querySelector('[name="po3_test_weight"]');
        
        // Calculate total used weight excluding the current input
        function getUsedWeightExcluding(excludeInput) {
            let total = 0;
            if (po1Select.value && po1Weight !== excludeInput) {
                total += parseInt(po1Weight.value) || 0;
            }
            if (po2Select.value && po2Weight !== excludeInput) {
                total += parseInt(po2Weight.value) || 0;
            }
            if (po3Select.value && po3Weight !== excludeInput) {
                total += parseInt(po3Weight.value) || 0;
            }
            return total;
        }
        
        // Update max values for each enabled weight input
        if (!po1Select.disabled && po1Select.value) {
            const usedWeight = getUsedWeightExcluding(po1Weight);
            po1Weight.max = 100 - usedWeight;
        }
        
        if (!po2Select.disabled && po2Select.value) {
            const usedWeight = getUsedWeightExcluding(po2Weight);
            po2Weight.max = 100 - usedWeight;
        }
        
        if (!po3Select.disabled && po3Select.value) {
            const usedWeight = getUsedWeightExcluding(po3Weight);
            po3Weight.max = 100 - usedWeight;
        }
        
        // Ensure current values don't exceed new max
        [po1Weight, po2Weight, po3Weight].forEach(weight => {
            if (parseInt(weight.value) > parseInt(weight.max)) {
                weight.value = weight.max;
            }
        });
    }

    // Initialize event listeners for weight inputs
    document.addEventListener('DOMContentLoaded', function() {
        ['addCampaignForm', 'editCampaignForm'].forEach(formId => {
            const form = document.getElementById(formId);
            if (form) {
                // Initial disable state for both selects and weights
                form.querySelectorAll('[name$="_test_id"]').forEach((select, index) => {
                    select.disabled = true;
                    const weightInput = form.querySelector(`[name="po${index + 1}_test_weight"]`);
                    weightInput.disabled = true;
                    
                    // Add input event listener for weight changes
                    weightInput.addEventListener('input', () => updateMaxWeights(form));
                });
                
                // Set up change listeners for PO1 and PO2
                const po1Select = form.querySelector('[name="po1_test_id"]');
                const po2Select = form.querySelector('[name="po2_test_id"]');
                
                po1Select.addEventListener('change', () => updateTestDependencies(form));
                po2Select.addEventListener('change', () => updateTestDependencies(form));
            }
        });
    });
</script>
{% endblock %}